---
title: "Data Wrangling"
output: learnr::tutorial
runtime: shiny_prerendered
---


<!-- Add JavaScript code for making the exercise code larger -->
<script language="JavaScript" src="js/exercise-font-size.js"></script>

```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)


packages=c("tidyverse","learnr")
sapply(X=packages,FUN=function(x) if(!require(x,character.only=TRUE))  install.packages(x,dependencies=TRUE) )

library(learnr)
library(tidyverse)

tutorial_options(exercise.timelimit = 60)

accidents<-read_csv("accidents.csv")

accidents_with_injuries <- accidents %>% 
  filter(INJURIES > 0, INJURIES < 78)

accidents_with_injuries<- accidents_with_injuries %>% 
         mutate(PERCENTSERIOUS=SERIOUSINJURIES/INJURIES)
```

---

## Introduction

In this tutorial, we will look at traffic accident data in Seattle.
The data are open and made available [online](https://data-seattlecitygis.opendata.arcgis.com/datasets/5b5c745e0f1f48e7a53acec63a0022ab_0) by Seattle GeoData. 
It covers all recorded accidents in Seattle from 2004 to the present; some of the variables were deleted for the purposes of this exercise.

```{r fig, out.width="100%"}

knitr::include_graphics("images/traffic.jpg")

```

### Learning goals

- Continue practising data visualization skills with ggplot2. 
- Filter data for certain attributes with `filter()`. 
- Create new variables based on existing variables in the data with `mutate()`. 


### Packages

We'll use the **tidyverse** package for the analysis.
This package is already installed for you, so you load it as usual by running the following code:

```{r load-packages, exercise = TRUE}
library(tidyverse)

```


## Data

Below is an excerpt of the data dictionary also known as the code book.  Note that it is long (there are lots of variables in the data), but we will be using a limited set of the variables in this tutorial.

| Header                        |  Description
|:----------------|:--------------------------------
| `OBJECTID` | unique identifier
| `INCKEY` | unique key for the incident
| `COLDETKEY` | secondary key for the incident
| `ADDRTYPE` | Collision address type: **alley**, **block**, **intersection** 
| `LOCATION` | Description of the general location of the collision
| `SEVERITYCODE` |3 - fatality, 2b - serious injury, 2 -injury, 1 - property damage, 0 - unknown
| `SEVERITYDESC   ` | Detailed description of severity
| `COLLISIONTYPE` | Collision type
| `PERSONCOUNT` | Number of people involved in the collision
|`PEDCOUNT` |Number of pedestrians involved in the collision
| `PEDCYLCOUNT` | Number of bicycles involved in the collision 
|`VEHCOUNT`| Number of vehicles involved in the collision (0,1,etc)
|`INJURIES  `|Number of total injuries in the collision
|`SERIOUSINJURIES`|Number of serious injuries in the collision
|`FATALITIES`| Number of fatalities in the collision
|`INCDATE`| Date of incident
|`UNDERINFL`| Whether or not the driver was under the influence of drugs or alcohol
|`WEATHER`|A description of the weather conditions during the collision
|`ROADCOND`|The condition of the road during the collision
|`LIGHTCOND`|Light conditions during the collision
|`SPEEDING`|  Whether or not speeding was a factor in the collision (Y/N)
|`HITPARKEDCAR`|Whether or not the collision involved hitting a parked car.

### First look at the data

You can take a peek at the data using the `glimpse()` function in the box below. You can also take a look at the first few rows of the dataset using `head()`.Try both in the code chunk below. 

```{r glimpse-data, exercise = TRUE}

```

```{r quiz-rows}
question("What does each row in the dataset represent?",
    answer("The registration number of a car"),
    answer("The location of an accident"),
    answer("A recorded accident",
           correct = TRUE,
           message = "Each row in the dataset contains all information relating to an individual recorded accident in Seattle."),
    answer("An insurance claim "),
    allow_retry = TRUE
  )
```

How many accidents were recorded in Seattle from 2004? The output from `glimpse` should give you the answer. But you can also use `nrow(accidents)` to verify the answer. Try it in the code chunk below. 

```{r nrow,exercise=TRUE}
nrow(accidents)
```

How many variables are recorded on each crash? Use `ncol` in the code chunk below.

```{r ncol, exercise=TRUE}

```

```{r quiz-vars}
question("What type of variable is ADDRTYPE?",
    answer("Numerical"),
    answer("Categorical with ordered categories"),
    answer("Categorical with unordered categories ", correct=TRUE),
    allow_retry = TRUE
  )
```

## Multi-vehicle accidents

Let's use `filter` to subset the data to those accidents that involved 2 or more vehicles. Use the hints in the code chunk below to perform the filtering. Don't forget to remove the comment `#` symbols.   

``` {r vehicles, exercise = TRUE}
#___ %>%
#  ___(___) %>%
#  nrow()
```

```{r vehicles-hint-1}
#Use filter() to find the rows that match the criteria.
```

```{r vehicles-hint-2}
#Review the data dictionary, specifically the variables VEHCOUNT.
```

``` {r vehicles-hint-3}
#accidents %>%
#  filter(VEHCOUNT >= ___) %>% nrow()
```

``` {r vehicles-hint-4}
accidents %>%
  filter(VEHCOUNT >= 2) %>% nrow()
```


For more practice with `filter`, try subsetting the data to include only those accidents that involved speeding. 

``` {r filter-accidents-three, exercise = TRUE}


```

```{r filter-accidents-three-solution}
accidents %>%
    filter(SPEEDING=="Y") %>%
    nrow()
```


For even more practice, how many accidents involved 2 or more vehicles and speeding?

```{r filter-accidents-four, exercise=TRUE} 


```


```{r filter-accidents-four-solution}
accidents %>%
    filter(SPEEDING=="Y", VEHCOUNT > 0) %>%
    nrow()
```


## Injuries

The variable `INJURIES` describes the total number of injuries.
The dataframe `accidents_with_injuries` contains the subset of accidents with injuries. 

How many such accidents are there?

```{r accidents-injuries,exercise=TRUE}


```

```{r accidents-injuries-solution}

nrow(accidents_with_injuries)

```

The following code creates a new variable called `PERCENTSERIOUS` which stores the percentage of injuries at an accident that were serious.

```{r injury, echo=TRUE}
accidents_with_injuries<- accidents_with_injuries %>% 
         mutate(PERCENTSERIOUS=SERIOUSINJURIES/INJURIES)

```


Make a histogram of this variable using `ggplot`. What do you learn from this graph?

```{r ggplot-injury,exercise=TRUE}


```

Congratulations! You made it! You will be doing a lot more with the data wrangling tools in tidyverse, but this is a good start!

## Acknowledgements

The R code for creating this learnr tutorial was greatly informed by the learnr tutorials in [Data Science in a Box](https://datasciencebox.org/interactive-tutorials.html).


